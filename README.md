# Capacitor POC

See this note in french: https://notes.sklein.xyz/Projet%2017/

Mobile application built with Capacitor, which simply opens a *webview* that redirects to an online site (defined by `START_URL` variable environement).

The Capacitor application in this POC displays the content of a demonstration website, with the HTML content located in the `./dummy-website/` folder.  
This website is served by an HTTP Nginx server, launched using `docker-compose.yml`.

## Here are the elements tested and implemented in this POC

Application capacity :

- Application icon configuration (with [`@capacitor/assets`](https://github.com/ionic-team/capacitor-assets))
- SplashScreen image configuration (with [`@capacitor/assets`](https://github.com/ionic-team/capacitor-assets))
- Displaying the SSR dummy website in a webview (with [`@capacitor-os-inappbrowser`](https://github.com/ionic-team/capacitor-os-inappbrowser/))
- [Deep Linking with Universal and App Links](https://capacitorjs.com/docs/guides/deep-links) (for Android only) (with [`@capacitor/app`](https://www.npmjs.com/package/@capacitor/app))

Build and usage test:

- Create and test the application on Android in the Android emulator
- Application creation and testing on iOS via Scaleway Apple Silicon hosting instance

## Overview of Files and Folders

```sh
.
|-- .envrc : Contains application parameters in the form of environment variables used everywhere
├── android : Android project source code, automatically generated by Capacitor
├── assets
│   └── logo.png : Application logo that can be replaced
├── capacitor.config.json.tmpl : Template to automatically generate Capacitor configuration from environment variables
├── dist : Folder where the Capacitor application is built (with `npm run build`)
│   ├── assets
│   └── index.html
├── docker-compose.yml : Used only to expose the dummy website via nginx
├── dummy-website : Dummy website demonstration
│   ├── .weel-know/assetlinks.json : Deep-links authorization configuration file
│   ├── deep
│   └── index.html
├── ios : iOS project source code, automatically generated by Capacitor
├── keystore : Key to sign Android application
├── package.json
├── provisioning : Used only to deploy a Scaleway Silicon instance to build the iOS application
│   └── _ios.sh
├── scripts : Contains scripts to perform many actions more or less automatically
│   ├── apple-m1-get-info.sh
|   |   ...
│   └── upload-project-to-apple-m1.sh
└── src : Capacitor application source code, launch webview...
    ├── assets
    │   ├── icon
    │   ├── icons
    │   └── imgs
    ├── index.html
    ├── js
    │   └── online-webview.js
    └── manifest.json
```

## Prerequisite

- [Mise](https://mise.jdx.dev/installing-mise.html)
- yq
- java-21-openjdk

On Fedora, follow these instructions:

```sh
$ dnf install -y dnf-plugins-core
$ dnf config-manager --add-repo https://mise.jdx.dev/rpm/mise.repo
$ dnf install -y mise jq yq remmina remmina-plugins-vnc
```

## Start dummy website http server

Starting the Nginx service:

```sh
$ docker compose up -d --wait
```

## Expose dummy website on Internet

Why?  
The Android and iOS emulators do not have direct and easy access to the HTTP service (dummy website) exposed on `http://localhost:8080`.

To overcome this issue, I use [`cloudflared tunnel`](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/get-started/create-local-tunnel/).  
You can also use other solutions, such as [Sish](https://docs.ssi.sh/) or [ngrok Developer Preview](https://ngrok.com/use-cases/developer-preview).  
For more information, you can refer to the following note (in French): https://notes.sklein.xyz/2025-01-06_2105/zen/

```sh
$ ./scripts/start-cloudflare-http-tunnel.sh
Starting the tunnel...
…wait… …wait… …wait…
Tunnel started successfully: https://moral-clause-interesting-broadway.trycloudflare.com
```

Next, load the environment variables that will be used by capacitor to find out where the site to be shown is?

```
$ source ./scripts/load-variables.sh
Variables loaded:

START_URL=https://moral-clause-interesting-broadway.trycloudflare.com
ALLOW_NAVIGATION=moral-clause-interesting-broadway.trycloudflare.com
```

To stop the tunnel, you can execute:

```sh
$ ./scripts/stop-cloudflare-http-tunnel.sh
Stopping the tunnel (PID: 673143)...
Tunnel stopped successfully.
```

## Develop the application locally, directly in a browser

To contribute to the application, you don't need to run it in an Android or iOS emulator.
You can do most of your work directly in your browser, without any additional dependencies.

```sh
$ npm install
$ npm run start
```

Open your browser on http://localhost:5173

Edit web application source code in [`./src/`](./src/).

## Install Capacitor requirements

### Android requirements installation

```sh
$ mise install
$ rehash
$ sdkmanager --install \
    "emulator" \
    "platform-tools" \
    "build-tools;35.0.0" \
    "cmdline-tools;16.0" \
    "platforms;android-29" \
    "system-images;android-31;google_apis_playstore;x86_64"
$ avdmanager create avd \
    --name Pixel_Emulator \
    --package "system-images;android-31;google_apis_playstore;x86_64" \
    --device "pixel"
```


### iOS requirements installation on (Scaleway Apple Silicon)

```
$ cp .secret.tmpl .secret
```

Add parameters to `.secret` file.  
Reload variable env:

```sh
$ direnv allow
```

```sh
$ ./scripts/create-apple-m1.sh
$ ./scripts/enter-in-apple-m1.sh
Last login: Wed Nov 20 16:22:10 2024
m1@bb34d8ef-6305-4104-801c-1cf1b6b0f99f ~ % uname -a
Darwin bb34d8ef-6305-4104-801c-1cf1b6b0f99f 23.4.0 Darwin Kernel Version 23.4.0: Fri Mar 15 00:12:41 PDT 2024; root:xnu-10063.101.17~1/RELEASE_ARM64_T8103 arm64
```

It is also possible to connect to the server via VNC:

```sh
$ ./scripts/open-vnc.sh
```

Launches automatic installation script for iOS Capacitor requirements:

```sh
$ ./scripts/deploy-ios-requirements.sh
```

Teardown:

```sh
$ ./scripts/destroy-apple-m1.sh
```

## How to code on the project?

You can make changes in `src/`, test the application locally in a browser with `npm run start`…

Then, when you want to test your work in an iOS or Android emulator, you need to update the contents
of the `android/` and `ios/` folders with the command:

```sh
$ ./scripts/capacitor-sync.sh
```

### Launch application on Android

#### Start Android emulator device

Before running the `npx cap run android` command, as described later in this README, you must to launch an Android terminal emulator.  
To launch this terminal, run the following command and wait about 1min for the device to be ready.

```sh
$ $ANDROID_HOME/emulator/emulator -avd Pixel_Emulator
```

#### Build and launch app mobile in Android emulator

```sh
$ npm install
$ npm run build
$ ./scripts/capacitor-sync.sh
$ npx cap run android
```

or use `./scripts/refresh-all-and-start-android.sh` script.

### Launch application on iOS

```sh
$ ./scripts/upload-project-to-apple-m1.sh
```

#### Start iOS emulator device

```sh
$ ./scripts/enter-in-apple-m1.sh
$ export DEVICE_UDID=$(xcrun simctl list devices -j | jq -r '.devices["com.apple.CoreSimulator.SimRuntime.iOS-17-5"][] | select(.name == "iPhone 15") | .udid')
$ xcrun simctl boot $DEVICE_UDID
```
#### Build and launch app mobile in iOS emulator

```sh
$ ./scripts/enter-in-apple-m1.sh
$ cd projet
$ mise install
$ npm install
$ npm run build
$ ./scripts/capacitor-sync.sh
$ npx cap run ios --target="${DEVICE_UDID}"
```

See device simulator in VNC:

```sh
$ ./scripts/open-vnc.sh
```

<img src="screenshots/ios-device-emulator-in-vnc.png" />

#### What should I do if I've modified the source code on my workstation?

On your workstation, execute:

```sh
$ ./scripts/upload-project-to-apple-m1.sh
```

In *apple-m1 server*, execute:

```
$ npm install # optional
$ ./scripts/capacitor-sync.sh
$ npx cap run ios --target="${DEVICE_UDID}"
```

### Tips and tricks

#### How to regenerate `android` and `ios` folders

If you're updating the `@capacitor/android` or `@capacitor/ios` packages, I think it's a good idea to regenerate the `android` and `ios` folders:

```sh
$ rm -rf android
$ npx cap add android
```

```sh
$ rm -rf ios
$ npx cap add ios
```

#### How to regenerate Logo assets?

To change the application logo, you can edit the files in `./assets/`.

Then run the following command:

```sh
$ npx capacitor-assets generate
```

This command generates all assets in the following folders:

- `./android/app/src/main/res/`
- `./ios/App/App/Assets.xcassets/`
- `./src/assets/`

For more information, see: https://github.com/ionic-team/capacitor-assets

#### How to View console.log Messages in the Android Emulator?

You can directly see `console.log` with `adb`:

```
$ adb logcat | grep -i 'console'
...
```

Or open `chrome://inspect` in Chrome, and you see:

<img src="screenshots/chrome-inspect.png" />

Click "inspect" on "My supper app".

Then you can inspect the Capacitor application running in the emulator, just as you would with a conventional website.

`adb logcat` is a valuable tool for debugging as it provides access to the complete event logs of the Android emulator.
It offers a detailed view of the system logs, which can be useful for diagnosing issues and monitoring the behavior of the application.

#### Android package management

List packages installed in the Android emulator:

```sh
$ adb shell pm list packages
...
```

Clean:

```sh
$ adb shell pm clear android
$ adb shell pm clear com.android.chrome
```

Uninstall a package:

```sh
$ adb uninstall xyz.sklein.myapp
```

#### How do I refresh the Android App Link configuration and check that it's working properly?

Android-specific tip.

Here's the command you need to run to refresh the application's App Link configuration: 

```sh
$ adb shell pm verify-app-links --re-verify ${PACKAGE_NAME}
```
App Link configuration check:

```sh
$ adb shell pm get-app-links ${PACKAGE_NAME}
  xyz.sklein.myapp:
    ID: 100ba7e3-b978-49ac-926c-8e6ec6810f5c
    Signatures: [AF:AE:25:7F:ED:98:49:A3:E0:23:B3:BE:92:08:84:A5:82:D1:80:AA:E0:A4:A3:D3:A0:E2:18:D6:70:05:67:ED]
    Domain verification state:
      association-pending-belt-acute.trycloudflare.com: verified
```

Another App Link configuration check:

```
$ adb shell am start -W -a android.intent.action.VIEW -d "$(cat .cloudflared_tunnel_url)"
Starting: Intent { act=android.intent.action.VIEW dat=https://sc-lo-welsh-injury.trycloudflare.com/... }
Status: ok
LaunchState: COLD
Activity: xyz.sklein.myapp/.MainActivity
TotalTime: 1258
WaitTime: 1266
Complete
```

Another check when the application is already open:

```sh
$ adb shell am start -W -a android.intent.action.VIEW -d "$(cat .cloudflared_tunnel_url)"
Starting: Intent { act=android.intent.action.VIEW dat=https://sc-lo-welsh-injury.trycloudflare.com/... }
Warning: Activity not started, its current task has been brought to the front
Status: ok
LaunchState: HOT
Activity: xyz.sklein.myapp/.MainActivity
TotalTime: 73
WaitTime: 75
Complete
```

#### How to test application opening through a URL?

```sh
$ adb shell am start -W -a android.intent.action.VIEW -d "$(cat .cloudflared_tunnel_url)/deep/?query=foobar"
Starting: Intent { act=android.intent.action.VIEW dat=https://sc-lo-welsh-injury.trycloudflare.com/... }
Warning: Activity not started, its current task has been brought to the front
Status: ok
LaunchState: HOT
Activity: xyz.sklein.myapp/.MainActivity
TotalTime: 73
WaitTime: 75
Complete
```

#### How to test application on physical Android Smartphone?

Start by activating “developer mode” on your Android smartphone (operation not documented here).

Built an `apk` package with the following command:

```
$ ./scripts/build-android-dev-app.sh
Starting a Gradle Daemon (subsequent builds will be faster)

...

BUILD SUCCESSFUL in 13s
166 actionable tasks: 166 up-to-date
app/build/outputs/apk/debug/app-debug.apk created
```

List USB-connected devices, to select where to install the application:

```sh
$ adb devices
List of devices attached
24cc6cfc        device
```

Finally, install the `.apk`:

```sh
$ adb -s 24cc6cfc install android/app/build/outputs/apk/debug/app-debug.apk
```

Check that the application has been installed correctly:

```sh
$ adb -s 24cc6cfc shell pm list packages | grep "myapp"
package:xyz.sklein.myapp
```

Launching the application via an app link:

```sh
$ adb -s 24cc6cfc shell am start -W -a android.intent.action.VIEW -d "$(cat .cloudflared_tunnel_url)"
```

Launching the application via a deep link:

```sh
$ adb -s 24cc6cfc shell am start -W -a android.intent.action.VIEW -d "$(cat .cloudflared_tunnel_url)/deep/?query=foobar"
```
